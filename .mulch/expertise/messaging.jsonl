{"type":"decision","title":"Custom SQLite Mail over Beads","rationale":"Mail is high-frequency (agents poll every prompt via hooks). bd CLI at 50-200ms too slow for 10+ agents. SQLite via bun:sqlite gives 1-5ms queries. Beads owns tasks, mail owns communication. Independent failure domains.","classification":"foundational","recorded_at":"2026-02-12T15:18:14.233Z","tags":["sqlite","mail","performance"],"id":"mx-04e745"}
{"type":"convention","content":"Mail client operations that take a message ID should always validate existence before acting. The store layer (L1) is intentionally lenient (SQLite UPDATE on missing row is a no-op), but the client layer (L2) must enforce existence checks and throw MailError with the messageId in context. Validate enum-like CLI inputs (type, priority) at the command layer before casting with 'as', using a const array of valid values and includes() check.","classification":"tactical","recorded_at":"2026-02-12T16:43:56.188Z","id":"mx-7170fd"}
{"type":"pattern","name":"SQLite CHECK constraint migration","description":"Schema migration for CHECK constraints in SQLite: Since SQLite doesn't support ALTER TABLE ADD CONSTRAINT, migrate by renaming old table, creating new table with constraints, copying data with CASE expressions to sanitize invalid values to defaults, then dropping the old table. Wrap in a transaction. Gate migration on inspecting sqlite_master.sql for existing CHECK keyword presence.","classification":"tactical","recorded_at":"2026-02-12T17:50:11.295Z","id":"mx-29a023"}
{"type":"failure","description":"mail reply routed to self when replier was the original sender: reply() always set to=original.from, but when from===original.from the reply goes back to yourself.","resolution":"Determine recipient dynamically: if from===original.from, reply to original.to; otherwise reply to original.from.","classification":"tactical","recorded_at":"2026-02-12T19:52:03.647Z","id":"mx-cce8e7"}
{"type":"failure","description":"mail list --unread appeared broken during E2E testing because mail check was run first, which marks messages as read as a side effect. Users expected mail check to be read-only but it silently mutates state.","resolution":"Added --agent flag to mail list as alias for --to, giving agent-scoped perspective without marking read. For debugging, use mail list --agent X --unread instead of mail check.","classification":"tactical","recorded_at":"2026-02-12T19:52:09.911Z","id":"mx-afabf2"}
